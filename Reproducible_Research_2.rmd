---
title: "Reproducible Research Assignment 2"
author: "Project_H"
date: "March 15, 2016"
output: 
  html_document:
    keep_md: yes
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Software Environment:
The analysis was built using:  
* R 3.2.4  
* data.table 1.9.6  
* readr 0.2.2

## Data Processing
Loading data: readr's read_csv is used to load the data, as it is an order of magnitude faster than the base read.csv. Unfortunately, the data file crashes data.table 1.9.6's fread function.

Summarizing data: For each Event Type, sum the fatalities, injuries, property damage, and crop damage.
```{r load_data}
require(data.table)
require(readr)
dataset <- data.table(read_csv('../repdata-data-StormData.csv.bz2'))

# Extract a summary of storm data events, a count of each EventType, and merge the two tables. EVCOUNT is forced to double precision, to suppress downstream warning messages from melt.data.table.
# There is a bug in data.table 1.9.6. When merging the two tables keyed on the EVTYPE column, the merge function does not perfectly preserve the EVTYPE data. That is, 
StormSum1 <- dataset[, lapply(.SD, sum, na.rm=TRUE), by=EVTYPE, 
                     .SDcols=c('FATALITIES', 'INJURIES', 'PROPDMG', 'CROPDMG')]
StormCount1 <- dataset[, .N, by = EVTYPE]
names(StormCount1)[2] <- 'EVCOUNT'
StormCount1$EVCOUNT <- as.double(StormCount1$EVCOUNT)
StormSum2 <- StormSum1[StormCount1, on='EVTYPE']

# Convert all EventTypes to upper case to reduce variation in Event Types
# StormSum4 <- StormSum2 
StormSum2[,EVTYPE := toupper(EVTYPE)]

# Get rid of spelling, punctuation, word order variations. Double escapes for literals are required because the regular expression is passed through data.table to grepl
StormSum2[EVTYPE == 'AVALANCE',  EVTYPE := 'AVALANCHE']
StormSum2[EVTYPE == 'BEACH EROSIN',  EVTYPE := 'BEACH EROSION']
StormSum2[EVTYPE %like% '^BLOWING SNOW[ &/-]*EXTREME', EVTYPE := 'BLOWING SNOW EXTREME WIND CHILL']
StormSum2[EVTYPE %like% 'BLOW-OUT TIDE[S]*', EVTYPE := 'BLOWOUT TIDE']
StormSum2[EVTYPE %like% '^BRUSH FIRE[S]*', EVTYPE := 'BRUSH FIRE']
StormSum2[EVTYPE %like% '^COASTAL[ ]*FLOOD(ING)*$', EVTYPE := 'COASTAL FLOOD']
StormSum2[EVTYPE == 'COLD TEMPERATURES', EVTYPE := 'COLD TEMPERATURE']
StormSum2[EVTYPE %like% 'DUST DEV[EI]L$', EVTYPE := 'DUST DEVIL']
StormSum2[EVTYPE %like% 'FLOO*D[/]*FLASH', EVTYPE := 'FLASH FLOOD']
StormSum2[EVTYPE %like% '^FLASH.*?FLOO[O]*D(S|ING)*$', EVTYPE := 'FLASH FLOOD']
StormSum2[EVTYPE %like% '^FLASH FLOOD/$', EVTYPE := 'FLASH FLOOD']
StormSum2[EVTYPE %like% '^FLOOD/FLASH', EVTYPE := 'FLASH FLOOD']
StormSum2[EVTYPE %like% 'FLOOD FLASH', EVTYPE := 'FLASH FLODD']
StormSum2[EVTYPE %like% '^FUNNEL CLOUD[\\.S]*$', EVTYPE := 'FUNNEL CLOUD']
StormSum2[EVTYPE %like% 'FROST[/\\]FREEZE', EVTYPE := 'FROST FREEZE']
StormSum2[EVTYPE %like% '^GRADIENT WIND[S]*$', EVTYPE := 'GRADIENT WIND']
StormSum2[EVTYPE %like% '^GUSTY WIND[S]*$', EVTYPE := 'GUSTY WIND']
StormSum2[EVTYPE %like% '^HAIL.*?( |0\\.|0)75$', EVTYPE := 'HAIL 075']
StormSum2[EVTYPE %like% '^HAIL\\(0\\.75', EVTYPE := 'HAIL 075']
StormSum2[EVTYPE %like% '^HAIL 80', EVTYPE := 'HAIL 080']
StormSum2[EVTYPE %like% '^HAIL.*?88$', EVTYPE := 'HAIL 088']
StormSum2[EVTYPE %like% '^HAIL 1[\\.]*00', EVTYPE := 'HAIL 100']
StormSum2[EVTYPE %like% '^HAIL 1[\\.]*75[\\)]*$', EVTYPE := 'HAIL 175']
StormSum2[EVTYPE %like% '^HAILSTORM[S]*$', EVTYPE := 'HAILSTORM']
StormSum2[EVTYPE %like% '^HAIL/WIND[S]*$', EVTYPE := 'HAIL WIND']
StormSum2[EVTYPE %like% '^HEAT WAVE[S]*$', EVTYPE := 'HEAT WAVE']
StormSum2[EVTYPE %like% '^HEAVY .*?BLOWING.*?SNOW', EVTYPE := 'HEAVY BLOWING SNOW']
StormSum2[EVTYPE %like% '^HEAVY RAIN[S]*$', EVTYPE := 'HEAVY RAIN']
StormSum2[EVTYPE %like% '^HEAVY SHOWER[S]*$', EVTYPE := 'HEAVY SHOWER']
StormSum2[EVTYPE %like% 'HEAVY SNOW[ /]*FREEZING RAIN', EVTYPE := 'HEAVY SNOW FREEZING RAIN']
StormSum2[EVTYPE %like% '^HEAVY SNOW[- ]SQUALLS$', EVTYPE := 'HEAVY SNOW SQUALL']
StormSum2[EVTYPE %like% '^LAKE[ -]*EFFECT SNOW', EVTYPE := 'LAKE EFFECT SNOW']
StormSum2[EVTYPE %like% '^LANDSLIDE[S]*$', EVTYPE := 'LANDSLIDE']
StormSum2[EVTYPE %like% '^LI.*?ING[\\.]*$', EVTYPE := 'LIGHTNING']
StormSum2[EVTYPE %like% '^LIGHTNING( AND |/)HEAVY RAIN', EVTYPE := 'LIGHTNING HEAVY RAIN']
StormSum2[EVTYPE %like% '^MARINE (TSTM|THUNDERSTORM) WIND', EVTYPE := 'MARINE THUNDERSTORM WIND']
StormSum2[EVTYPE %like% 'MUD[ ]*SLIDE[S]*$', EVTYPE := 'MUDSLIDE']
StormSum2[EVTYPE %like% '^RIP CURRENT[S]*$', EVTYPE := 'RIP CURRENT']
StormSum2[EVTYPE %like% '^RIP CURRENTS[ /]HEAVY SURF', EVTYPE := 'RIP CURRENT HEAVY SURF']
StormSum2[EVTYPE %like% '^FREEZING RAIN( AND |/)SLEET', EVTYPE := 'SLEET FREEZING RAIN']
StormSum2[EVTYPE %like% '^SLEET[ &/]*FREEZING RAIN', EVTYPE := 'SLEET FREEZING RAIN']
StormSum2[EVTYPE %like% '^SNOW[ /]*FREEZING RAIN', EVTYPE := 'SNOW FREEZING RAIN']
StormSum2[EVTYPE %like% '^FREEZING RAIN( AND |/)SNOW', EVTYPE := 'SNOW FREEZING RAIN']
StormSum2[EVTYPE %like% '^STRONG WIND[S]*$', EVTYPE := 'STRONG WIND']
StormSum2[EVTYPE %like% '^TIDAL FLOOD(ING)*$', EVTYPE := 'TIDAL FLOOD']
StormSum2[EVTYPE == 'TORNDAO',  EVTYPE := 'TORNADO']
StormSum2[EVTYPE %like% '^WATER *SPOUT[-/S]*$', EVTYPE := 'WATERSPOUT']
StormSum2[EVTYPE == 'WAYTERSPOUT',  EVTYPE := 'WATERSPOUT']
StormSum2[EVTYPE %like% '^WATERSPOUT[ /-]*TORNADO$', EVTYPE := 'WATERSPOUT TORNADO']
StormSum2[EVTYPE == 'TORNADO/WATERSPOUT', EVTYPE := 'WATERSPOUT TORNADO']
StormSum2[EVTYPE == 'WET MICOBURST',  EVTYPE := 'WET MICROBURST']
StormSum2[EVTYPE %like% '^WILD.*?FIRES*$', EVTYPE := 'WILDFIRE']
StormSum2[EVTYPE %like% '^WI*NDS*$', EVTYPE := 'WIND']
StormSum2[EVTYPE %like% 'WINTER WEATHER[ /]MIX', EVTYPE := 'WINTRY MIX']
StormSum2[EVTYPE %like% 'WINT(E?RY?) MIX', EVTYPE := 'WINTRY MIX']
StormSum2[EVTYPE %like% 'WINTER STORM[ /]HIGH WINDS*', EVTYPE := 'WINTER STORM HIGH WINDS']
StormSum2[EVTYPE == 'WINTER STORMS', EVTYPE := 'WINTER STORM']
StormSum2[EVTYPE %like% '^URBAN FLOOD[S|ING]*$', EVTYPE := 'URBAN FLOODING']
StormSum2[EVTYPE %like% '^URBAN.*?[SMALL|SML].*?STREAM.*?[FLOOD|FLD]*', EVTYPE := 'URBAN SMALL STREAM FLOODING']
StormSum2[EVTYPE == 'UNSEASONABLE COLD',  EVTYPE := 'UNSEASONABLY COLD']
StormSum2[EVTYPE %like% '^UNSEASONABLY WARM[ &/]*WET', EVTYPE := 'UNSEASONABLY WARM WET']

# Goal: THUNDERSTORM WIND. Lots of different patterns in Grep.
# Starting with TH and ending in ND or DS or DSS or ND. or NDS or INS.
# Metacharacter: . = any character
#              : * = Match the preceding element 0 or more times
#              : ? = Match the preceding element 0 or 1 time.
StormSum2[EVTYPE %like% '^TH.*?(ND$|DS[S]*$|ND[S]*\\.$|INS)', EVTYPE := 'THUNDERSTORM WIND']
StormSum2[EVTYPE %like% 'THUNDERSTORMW', EVTYPE := 'THUNDERSTORM WIND']
StormSum2[EVTYPE =='TUNDERSTORM WIND', EVTYPE := 'THUNDERSTORM WIND']

# Starting with 'TSTM W' and ending IN ND, NDS
StormSum2[EVTYPE %like% '^TSTM W.*?(ND$|DS$)', EVTYPE := 'THUNDERSTORM WIND']
StormSum2[EVTYPE %like% '^TSTMW', EVTYPE := 'THUNDERSTORM WIND']

# with numbers
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?40', EVTYPE := 'THUNDERSTORM WIND 40']
StormSum2[EVTYPE %like% '^TSTM WIND.*?45', EVTYPE := 'THUNDERSTORM WIND 45']
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?50', EVTYPE := 'THUNDERSTORM WIND 50']
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?52', EVTYPE := 'THUNDERSTORM WIND 52']
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?53', EVTYPE := 'THUNDERSTORM WIND 53']
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?59', EVTYPE := 'THUNDERSTORM WIND 59']
StormSum2[EVTYPE %like% '^THUN.*?60', EVTYPE := 'THUNDERSTORM WIND 60']
StormSum2[EVTYPE %like% '^THUN.*?61', EVTYPE := 'THUNDERSTORM WIND 61']
StormSum2[EVTYPE %like% '^(TSTM|THUN).*?65', EVTYPE := 'THUNDERSTORM WIND 65']


# setkey(StormSum2, EVTYPE)
# StormSum2[StormSum2[EVTYPE %like% '^TH.'][EVTYPE %like% 'ND$|DS$'], EVTYPE := 'THUNDERSTORM WINDS']
# Starting with TH and ending in IND or INS
# StormSum1[EVTYPE %like% '^TH.*IND$|^TH.*INS$', EVTYPE := 'THUNDERSTORM WINDS']
# Starting with TH and ending in NDS. or ND.
# StormSum1[EVTYPE %like% '^TH.*NDS\\.$|^TH.*ND\\.$', EVTYPE := 'THUNDERSTORM WINDS']

# Melt the summary to prepare for re-calculating the sums for each Event Type.
StormMelt <- melt.data.table(StormSum2, id.vars = 'EVTYPE', variable.name = 'DamageType')

# Redo the summary table, which essentially collapses duplicate rows created by correcting spelling and punctuation variations in EventType.
StormSum3 <- dcast(StormMelt, EVTYPE ~ DamageType, value.var = 'value', fun.aggregate = sum )

```

## 


